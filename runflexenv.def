Bootstrap: docker
From: ubuntu:20.04

%post

    # Install packages

    apt-get -y update
    apt-get -y upgrade

    apt install -y software-properties-common
    add-apt-repository universe

    apt-get -y update
    apt-get -y upgrade

    apt install -y git vim htop rsync rclone gfortran makedepf90 wget make
    apt install -y libeccodes0 libeccodes-dev
    apt install -y libnetcdff-dev

    # Install conda
    cd /opt
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    chmod +x miniconda.sh
    ./miniconda.sh -b -p /opt/conda

    # Create a conda environment and make sure it is automatically activated
    . /opt/conda/etc/profile.d/conda.sh
    conda create -y -n runflex python=3.10
    conda activate runflex
    python3 -m pip install loguru pandas tqdm netcdf4 tables h5py omegaconf ipython
    export LC_ALL=C
    echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
    echo "conda activate runflex" >> $SINGULARITY_ENVIRONMENT

    # Make directories
#    mkdir /runflex
    mkdir /meteo
    mkdir /output
    mkdir /scratch

    # Pre-install python package:
    export PYPTH=/opt/conda/envs/runflex/lib/python3.10/site-packages
    echo /runflex >> $PYPTH/easy-install.pth
    echo /runflex >> $PYPTH/lumia.egg-link

    # Install runflex
#    cd /runflex
#    make build
#    make install
#    rm -Rf /runflex/*

%environment
    export machine=singularity
    export CONDA_ENVS_PATH=/opt/conda/envs

%files
    . /runflex

%runscript
    if [ $# -ne 0 ]
    then
        . /opt/conda/etc/profile.d/conda.sh
        conda activate /opt/conda/envs/runflex
        runflex $@
    else
        . /opt/conda/etc/profile.d/conda.sh
        conda activate /opt/conda/envs/runflex
        bash
    fi
