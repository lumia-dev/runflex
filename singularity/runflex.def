Bootstrap: docker
From: ubuntu:20.04

%post

    # Install packages

    apt-get -y update
    apt-get -y upgrade

    apt install -y software-properties-common
    add-apt-repository universe

    apt-get -y update
    apt-get -y upgrade

    apt install -y git vim htop task-spooler rsync rclone gfortran makedepf90
    apt install -y python3.8 python3-pip python3-ipython ipython3 python3-numpy python3-tqdm python3-h5py python3-netcdf4 python3-pandas
    apt install -y libeccodes0 libeccodes-dev
    apt install -y libnetcdff-dev

    python3 -m pip install loguru

    # Make directories
    mkdir /flexpart    # The flexpart source code will be put there
    mkdir /meteo       # The meteo must be in that path (or it will be downloaded there!)
    mkdir /output      # The files will be written here
    mkdir /scratch     # Folder for temporary files

    # Install runflex
    cd /runflex
    pip install -e .
    rm -f singularity/*.sif

    # Pre-compile flexpart
    export machine=singularity
    python3 singularity/compile.py -b /flexpart --src flexpart10.4 --extra extras/ --fc gfortran

%files
    .. /runflex

%environment
    export machine=singularity

%runscript
    if [ $# -ne 0 ]
    then
        python3 /runflex/singularity/runscript.py $@
    else
        /bin/bash
    fi
