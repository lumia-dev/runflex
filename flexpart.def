Bootstrap: library
From: default/ubuntu:20.04

%post
    apt-get -y update
    apt-get -y upgrade

    apt install -y software-properties-common
    add-apt-repository universe

    apt-get -y update
    apt-get -y upgrade

    apt install -y git
    apt install -y gfortran
    apt install -y python3.8
    apt install -y vim
    apt install -y python3-pip
    apt install -y python3-ipython ipython3 python3-numpy python3-tqdm
    apt install -y rsync rclone
    apt install -y libeccodes0 libeccodes-dev
    apt install -y libnetcdff-dev
    apt install -y python3-pandas
    apt install -y task-spooler

    # Make sure that the env variables remain available when the container is run
    echo "export SINGULARITY_ENVIRONMENT=$SINGULARITY_ENVIRONMENT" >> $SINGULARITY_ENVIRONMENT
    echo "export PATH=$PATH" >> $SINGULARITY_ENVIRONMENT

    # Add aliases to $SINGULARITY_ENVIRONMENT (which is used as a bashrc replacement):
    echo "alias ls='ls --color=auto'" >> $SINGULARITY_ENVIRONMENT
    echo "alias lh='ls -lh'" >> $SINGULARITY_ENVIRONMENT
    echo "alias lt='ls -ltrh'" >> $SINGULARITY_ENVIRONMENT
    echo "alias la='ls -lthra'" >> $SINGULARITY_ENVIRONMENT
    echo "alias ll='ls -lh'" >> $SINGULARITY_ENVIRONMENT
    echo "alias l='ls -CF'" >> $SINGULARITY_ENVIRONMENT
    echo "alias rm='rm -i'" >> $SINGULARITY_ENVIRONMENT
    echo "alias grep='grep -i --color'" >> $SINGULARITY_ENVIRONMENT

    # Make sure we get a decent default vim:
    echo "set noopt" >> /etc/vim/vimrc
    echo "set nocompatible" /etc/vim/vimrc
    echo "set backspace=2" /etc/vim/vimrc
    echo "filetype plugin indent on" /etc/vim/vimrc
    echo "let fortran_free_source=1" /etc/vim/vimrc
    echo "filetype on" /etc/vim/vimrc
    echo "filetype plugin on" /etc/vim/vimrc
    echo "filetype indent on" /etc/vim/vimrc
    echo "set sw=4" /etc/vim/vimrc
    echo "let fortran_do_enddo=1" /etc/vim/vimrc
    echo "set hlsearch" /etc/vim/vimrc
    echo "set tw=0" /etc/vim/vimrc
    echo "set ttyfast" /etc/vim/vimrc
    echo "set smartcase" /etc/vim/vimrc
    echo "set t_Co=256" /etc/vim/vimrc
    echo "set tabstop=4" /etc/vim/vimrc
    echo "set shiftwidth=4" /etc/vim/vimrc

    # Make directories
    mkdir -p /build/flexpart

%environment
    export machine=singularity

%runscript
    cd $HOME
    bash --init-file $SINGULARITY_ENVIRONMENT

%apprun calcfootprints
    cd $HOME
    pip install -e .
    python3 scripts/compile.py --rc $1 --obs $2